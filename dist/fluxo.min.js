/*! fluxo-js v0.0.23 | (c) 2014, 2016 Samuel Sim√µes | https://github.com/fluxo-js/fluxo */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.Fluxo=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}Object.defineProperty(c,"__esModule",{value:!0});var h=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},i=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),j=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;if(void 0===i)return;return i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return;a=j,b=f,c=g,d=!0,h=j=void 0}},k=a("./fluxo.object_store.js"),l=d(k),m=function(a){function b(){f(this,b),j(Object.getPrototypeOf(b.prototype),"constructor",this).apply(this,arguments)}return g(b,a),i(b,[{key:"initialize",value:function(){var a=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];this.store=this.constructor.store||l["default"],this.stores=[],this.index={},this.storesOnChangeCancelers={},this.subsets={},this.subset=this.constructor.subset||{},this.childrenDelegate=this.constructor.childrenDelegate||[],j(Object.getPrototypeOf(b.prototype),"initialize",this).call(this,c),this.setStores(a),this.registerSubsets(),this.createDelegateMethods(),this.on(["change:stores"],function(){delete this.lastGeneratedJSON})}},{key:"firstComputation",value:function(){for(var a in this.subset)this.updateSubset(a);j(Object.getPrototypeOf(b.prototype),"firstComputation",this).call(this)}},{key:"getSubset",value:function(a){if(!this[a])throw new Error('Subset compute function to "'+a+'" subset is not defined.');var b=this[a].call(this);if(!b||b.constructor!==Array)throw new Error('The subset "'+a+"\" computer function returned a value that isn't an array.");return b}},{key:"updateSubset",value:function(a){this.subsets[a]||(this.subsets[a]=new b),this.subsets[a].resetStores(this.getSubset(a)),this.triggerEvent("change:"+a)}},{key:"registerSubsets",value:function(){for(var a in this.subset){var b=["add","remove"].concat(e(this.subset[a]));this.on(b,this.updateSubset.bind(this,a))}}},{key:"setAttribute",value:function(a){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];if(this.subset&&this.subset[a])throw new Error('The attribute name "'+a+'" is reserved to a subset.');if("stores"===a)throw new Error('You can\'t set a attribute with "stores" name on a collection.');return j(Object.getPrototypeOf(b.prototype),"setAttribute",this).apply(this,arguments)}},{key:"createDelegateMethods",value:function(){for(var a=0,b=this.childrenDelegate.length;b>a;a++){var c=this.childrenDelegate[a];this.createDelegateMethod(c)}}},{key:"createDelegateMethod",value:function(a){this.store.prototype[a]||console.warn('The "'+a+"\" children delegated method doesn't exists on children store class"),this[a]=function(a,b){var c=this.find(b);if(!c)throw new Error('You tried call the delegated method "'+a+'" on a missing child store.');for(var d=arguments.length,e=Array(d>2?d-2:0),f=2;d>f;f++)e[f-2]=arguments[f];c[a].apply(c,e)}.bind(this,a)}},{key:"addStores",value:function(a){for(var b=arguments.length<=1||void 0===arguments[1]?{silentGlobalChange:!1}:arguments[1],c=0,d=a.length;d>c;c++){var e=a[c];this.addStore(e,{silentGlobalChange:!0})}b.silentGlobalChange||this.triggerEvent("change")}},{key:"resetStores",value:function(){var a=arguments.length<=0||void 0===arguments[0]?[]:arguments[0];this.removeAll({silentGlobalChange:!0}),this.addStores(a,{silentGlobalChange:!0}),this.triggerEvent("change")}},{key:"removeAll",value:function(){for(var a=arguments.length<=0||void 0===arguments[0]?{silentGlobalChange:!1}:arguments[0],b=this.stores.length-1,c=0;b>=c;b--){var d=this.stores[b];this.remove(d,{silentGlobalChange:!0})}this.stores=[],a.silentGlobalChange||this.triggerEvent("change")}},{key:"setStores",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];b=h({removeMissing:!1},b);for(var c={},d=0,e=this.stores.length;e>d;d++){var f=this.stores[d];f.data.id?c[f.data.id]=f:c[f.cid]=f}for(var d=0,e=a.length;e>d;d++){var f=a[d],g=f.id||f.data&&f.data.id||f.cid,i=c[g];i&&delete c[g],i&&!f.cid?i.set(f,{silentGlobalChange:!0}):this.addStore(f,{silentGlobalChange:!0})}if(b.removeMissing)for(var g in c){var f=c[g];this.remove(f,{silentGlobalChange:!0})}this.triggerEvent("change")}},{key:"setStore",value:function(a){var b=this.find(a.id||a.cid),c=void 0;return b?(c=b,b.set(a)):c=this.addStore(a),c}},{key:"makeSort",value:function(){this.sort&&this.stores.sort(this.sort)}},{key:"addStore",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{silentGlobalChange:!1}:arguments[1];a instanceof this.store||(a=new this.store(a));var c=this.find(a.cid||a.data.id);if(c)return c;this.stores.push(a);var d=function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];if(this.triggerEvent.apply(this,["stores:"+a].concat(c)),"change"===a&&(this.makeSort(),this.triggerEvent("change")),"change:id"===a){var e=c[0],f=c[1];f&&delete this.index[f],e.data.id&&(this.index[e.data.id]=e)}};return this.storesOnChangeCancelers[a.cid]=a.on(["*"],d.bind(this)),this.makeSort(),this.index[a.cid]=a,a.data.id&&(this.index[a.data.id]=a),this.triggerEvent("add"),b.silentGlobalChange||this.triggerEvent("change"),a}},{key:"find",value:function(a){return this.index[a]}},{key:"findWhere",value:function(a){return this.where(a,!0)[0]}},{key:"where",value:function(a,b){var c=[];if(!a)return[];for(var d=0,e=this.stores.length;e>d;d++){var f=this.stores[d],g=!0;for(var h in a)if(f.data[h]!==a[h]){g=!1;break}if(g&&(c.push(f),b))break}return c}},{key:"removeListenersOn",value:function(a){this.storesOnChangeCancelers[a.cid].call(),delete this.storesOnChangeCancelers[a.cid]}},{key:"remove",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];b=h({silentGlobalChange:!1},b),this.removeListenersOn(a),this.stores.splice(this.stores.indexOf(a),1),this.makeSort(),delete this.index[a.cid],a.data.id&&delete this.index[a.data.id],this.triggerEvent("remove"),b.silentGlobalChange||this.triggerEvent("change")}},{key:"storesToJSON",value:function(){for(var a=[],b=0,c=this.stores.length;c>b;b++){var d=this.stores[b];a.push(d.toJSON())}return a}},{key:"subsetsToJSON",value:function(){var a={};for(var b in this.subsets)a[b]=this.subsets[b].toJSON().stores;return a}},{key:"toJSON",value:function(){return this.lastGeneratedJSON||(this.lastGeneratedJSON=h({},this.attributesToJSON(),this.subsetsToJSON(),{stores:this.storesToJSON()})),this.lastGeneratedJSON}}]),b}(l["default"]);c["default"]=m,b.exports=c["default"]},{"./fluxo.object_store.js":4}],2:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]={parser:function(a){return a},dump:function(a){return JSON.parse(JSON.stringify(a))}},b.exports=c["default"]},{}],3:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(c,"__esModule",{value:!0});var e=a("./fluxo.object_store.js"),f=d(e),g=a("./fluxo.collection_store.js"),h=d(g);c["default"]={ObjectStore:f["default"],CollectionStore:h["default"]},b.exports=c["default"]},{"./fluxo.collection_store.js":1,"./fluxo.object_store.js":4}],4:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var f=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./fluxo.default_attribute_contract.js"),i=d(h),j=1,k=function(){function a(){e(this,a),this.initialize.apply(this,arguments),this.firstComputation()}return g(a,[{key:"initialize",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.cid="FS:"+j++,this.data={},this.storeAttributesEventsCanceler={},this.computed=this.constructor.computed||{},this.attributeParsers=this.constructor.attributeParsers||{},this.signedEventsCancelers=[],this.events={},this.setDefaults(),this.set(a),this.registerComputed(),this.on(["change"],function(){delete this.lastGeneratedJSON}),this.warnMissingAttributes()}},{key:"warnMissingAttributes",value:function(){if(this.constructor.attributes)for(var a in this.constructor.attributes)this.warnMissingAttribute(a,this.data[a])}},{key:"warnMissingAttribute",value:function(a,b){if(this.contract(a).required&&(void 0===b||null===b)){var c="";c=this.data.id?"id: "+this.data.id:"cid: "+this.cid;var d='Warning: missing the required "'+a+'" attribute on the "'+this.constructor.name+'" store ('+c+")";console.warn?console.warn(d):console(d)}}},{key:"getDefaults",value:function(){if(this.constructor.attributes){var a={};for(var b in this.constructor.attributes)a[b]=this.contract(b).defaultValue;return JSON.parse(JSON.stringify(a))}}},{key:"setDefaults",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{silentGlobalChange:!1}:arguments[0],b=this.getDefaults();for(var c in b)this.setAttribute(c,b[c],a)}},{key:"firstComputation",value:function(){for(var a in this.computed)this.computeValue(a)}},{key:"subscribe",value:function(a,b){if("function"!=typeof b)throw new Error("Callback must be a function");return this.events[a]=this.events[a]||[],this.events[a].push(b),this.removeSubscription.bind(this,a,b)}},{key:"removeSubscription",value:function(a,b){var c=this.events[a].indexOf(b);this.events[a].splice(c,1),this.events[a]||delete this.events[a]}},{key:"publish",value:function(a){var b=this.events[a];if(b){for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;c>e;e++)d[e-1]=arguments[e];for(var f=0;f<b.length;f++)b[f].apply(null,d)}}},{key:"on",value:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=a[d],g=f,h=this.subscribe(g,b.bind(this));c.push(h)}var i=function(){for(var a=0,b=c.length;b>a;a++){var d=c[a];d.call()}};return this.signedEventsCancelers.push(i),i}},{key:"triggerEvents",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];for(var e=0,f=a.length;f>e;e++){var g=a[e];this.triggerEvent.apply(this,[g].concat(c))}}},{key:"triggerEvent",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];this.publish.apply(this,[a,this].concat(c)),this.publish.apply(this,["*",a,this].concat(c))}},{key:"getComputed",value:function(a){if(!this[a])throw new Error('Compute function to "'+a+'" value is not defined.');return this[a].call(this)}},{key:"computeValue",value:function(a){this.setAttribute(a,this.getComputed(a),{silentGlobalChange:!0})}},{key:"registerComputed",value:function(){for(var a in this.computed){var b=this.computed[a];this.on(b,this.computeValue.bind(this,a))}}},{key:"stopListenStoreAttribute",value:function(a){this.storeAttributesEventsCanceler[a].call(),delete this.storeAttributesEventsCanceler[a]}},{key:"listenStoreAttribute",value:function(a,b){var c=function(a,b){if("change"!==b){for(var c=arguments.length,d=Array(c>2?c-2:0),e=2;c>e;e++)d[e-2]=arguments[e];this.triggerEvent.apply(this,["change:"+a+":"+b.replace(/^change:/,"")].concat(d))}("change"===b||"stores:change"===b)&&(this.triggerEvent("change:"+a),this.triggerEvent("change"))};this.storeAttributesEventsCanceler[a]=b.on(["*"],c.bind(this,a))}},{key:"contract",value:function(a){return this.constructor.attributes&&this.constructor.attributes[a]?this.constructor.attributes[a]:{}}},{key:"parser",value:function(a){return this.contract(a).parser||i["default"].parser}},{key:"dump",value:function(a){return this.contract(a).dump||i["default"].dump}},{key:"setAttribute",value:function(b,c,d){if("string"!=typeof b)throw new Error('The "attribute" argument on store\'s "setAttribute" function must be a string.');if(d=d||{},this.data[b]!==c){delete this.lastGeneratedJSON,c=this.parser(b).call(this,c),this.warnMissingAttribute(b,c),this.data[b]instanceof a&&this.stopListenStoreAttribute(b),c instanceof a&&this.listenStoreAttribute(b,c);var e=this.data[b];this.data[b]=c,this.triggerEvent("change:"+b,e),d.silentGlobalChange||this.triggerEvent("change")}}},{key:"unsetAttribute",value:function(b,c){c=c||{},this.warnMissingAttribute(b),this.data[b]instanceof a&&this.stopListenStoreAttribute(b),delete this.data[b],this.triggerEvent("change:"+b),c.silentGlobalChange||this.triggerEvent("change")}},{key:"set",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?{silentGlobalChange:!1}:arguments[1];if("object"!=typeof a)throw new Error('The "data" argument on store\'s "set" function must be an object.');for(var c in a)this.setAttribute(c,a[c],{silentGlobalChange:!0});b.silentGlobalChange||this.triggerEvent("change")}},{key:"cancelSignedEvents",value:function(){for(var a=0,b=this.signedEventsCancelers.length;b>a;a++){var c=this.signedEventsCancelers[a];c.call()}}},{key:"reset",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=f({},this.data),c=this.getDefaults();for(var d in this.computed)delete b[d];for(var d in a)this.setAttribute(d,a[d],{silentGlobalChange:!0}),delete b[d],delete c[d];for(var d in c)this.setAttribute(d,c[d],{silentGlobalChange:!0}),delete b[d];for(var d in b)this.unsetAttribute(d,{silentGlobalChange:!0});this.triggerEvent("change")}},{key:"clear",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a=f({silentGlobalChange:!1},a);for(var b in this.data)this.computed.hasOwnProperty(b)||this.unsetAttribute(b,{silentGlobalChange:!0});a.silentGlobalChange||this.triggerEvent("change")}},{key:"attributesToJSON",value:function(){var a={};for(var b in this.data)a[b]=this.dump(b).call(this,this.data[b]);return f({},a,{cid:this.cid})}},{key:"toJSON",value:function(){return this.lastGeneratedJSON||(this.lastGeneratedJSON=this.attributesToJSON()),this.lastGeneratedJSON}}]),a}();c["default"]=k,b.exports=c["default"]},{"./fluxo.default_attribute_contract.js":2}]},{},[3])(3)});
//# sourceMappingURL=fluxo.map